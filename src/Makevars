# Use C++11 because libcmaes expects it
# dropped as R CMD check complains
#CXX_STD = CXX11

# libcmaes.a static library, built after its cmake build
LIBCMAES = libcmaes/build/src/libcmaes.a
# linker flags for our SHLIB
PKG_LIBS = $(LIBCMAES)

# include Eigen flags, e.g. EIGEN_CPPFLAGS += -I/usr/include/eigen3
-include Makevars.eigen

# include libcmaes headers
PKG_CPPFLAGS = $(EIGEN_CPPFLAGS) -Ilibcmaes/include -Ilibcmaes/build/include

# build shlib, but depend on static libcmaes.a
# targets created as recommended by WRE
.PHONY: all
all: $(SHLIB)
$(SHLIB): $(LIBCMAES)

# build libcmaes.a via cmake
# switch off a bunch of things we don't need:
#  python bindings, examples, tests, surrogates, openmp
$(LIBCMAES):
	(cd libcmaes; \
	  CC="$(CC)" CXX="$(CXX11)" \
	  cmake -S . -B build \
	    -DCMAKE_CXX_FLAGS="$(CXX11FLAGS) -DLIBCMAES_LOG_TO_R=1" \
	    -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
	    -DLIBCMAES_BUILD_SHARED_LIBS=OFF \
	    -DLIBCMAES_BUILD_PYTHON=OFF \
	    -DLIBCMAES_BUILD_EXAMPLES=OFF \
	    -DLIBCMAES_ENABLE_SURROG=OFF \
	    -DLIBCMAES_USE_OPENMP=OFF \
	    -DCMAKE_BUILD_TYPE=Release ;\
	  $(MAKE) -C build)


# make our src files also depend on libcmaes.a
# (inferred by R from all compilable sources in src/; e.g., .c, .cc, .cpp, .f)
# otherwise we get:
# libcmaes/include/libcmaes/pwq_bound_strategy.h:26:10: fatal error: libcmaes/cmaes_export.h: No such file or directory
$(OBJECTS): $(LIBCMAES)
